<!DOCTYPE html>
<html> <head>
<title>Delayed WebRequest Demo</title>
<%= stylesheet_link_tag "application", :media => "all" %>
<%= javascript_include_tag "application" %>
<%= javascript_include_tag :defaults %>

<%= csrf_meta_tags %>
<script src="http://js.pusher.com/1.11/pusher.min.js"
        type="text/javascript"></script>

<script type="text/javascript">
<!--

//Browser support code:

function AjaxObject(){
  var result;
  try{ //Gecko: Mozilla, Firefox; Webkit: Chrome, Safari; ?: Opera; (etc.?) browsers:
    result = new XMLHttpRequest();
  } catch (e){ //Internet Explorer browsers:
    try{
      result = new ActiveXObject('Msxml2.XMLHTTP');
    } catch (e) {
      try{
        result = new ActiveXObject('Microsoft.XMLHTTP');
      } catch (e){ //Something went wrong:
        alert('Unable to obtain an Ajax object.');
        return false;
      }
    }
  }
  return result;
}

//Non-browser support code:

// Enable pusher logging - don't include this in production
Pusher.log = function(message) {
  if (window.console && window.console.log) window.console.log(message);
};

// Flash fallback logging - don't include this in production
WEB_SOCKET_DEBUG = true;
var pusher = new Pusher('<%= Pusher.key %>'); // uses your API KEY
var channel = pusher.subscribe('test_channel');

channel.bind('greet', function(data) {
  alert(data.greeting);
  requestAjaxUpdate();
//alterTargets();
});

var newContent = "<ol><li>hello</li><li>there</li><li>in</li><li>Pusher land</li></ol>"

function targetIds() {
  return ["one", "two", "three", "four", "five"];
}

function Target(id) { //From string to property.
  this.id = id;
}

function selectTargets() {
  var targetIdsVar = targetIds();
  var len = targetIdsVar.length;
  var result = new Array(len);
  var each;
  for (var i = 0; i < len; i++) {
    each = targetIdsVar[i];
    result[i] = new Target(each);
  }
  result.push(new Target("junk")); //Temporary test.
  return result;
}

function alterTargets() {
  //$('#one').css("color","yellow");
  var targets = selectTargets();
  var elem;
  var len = targets.length;
  for (var i = 0; i < len; i++) {
    elem = document.getElementById(targets[i].id);
    if (null === elem) continue;
    elem.innerHTML = newContent;
  }
}

function requestAjaxUpdate() {


//  jQuery.ajax ( '/ajax_load_events.json', 






}

function replaceOne() {
  var becomes = 'new stuff';
  //var a = jQuery('#one');
  a.empty();
  a.append(becomes);
}

// When the DOM is fully loaded:
//jQuery(window.document).ready(function() {
window.document.addEventListener('DOMContentLoaded', function() {
  alert('window.document ready (DOMContentLoaded)');
  requestAjaxUpdate();
  //jQuery.get('/ajax_load_events.json', 'one', function(response) {
  //replaceOne();
  //alert(response);
}, false);

// When images, etc. are fully loaded:
//jQuery(window).load(function() {
window.onload = function() {
  //alert('window.onload');
};

//-->
</script> </head> <body>

<p>From Rails.cache.read:<br /> &nbsp;
<%= @cached_foo %></p>

<div id="error"></div>

<div id="one">one-content</div>
<div id="two">two-content</div>
<div id="three">three-content</div>
<div id="four">four-content</div>
<div id="five">five-content</div>

<% u = url_for '/ajax_load_events.json' %>
<%= u %>

<%#= link_to 'Ajax update', {:controller => 'welcome', :action => 'ajax_load_events', :remote => true, :update => 'one'} %>
<%#= link_to 'Ajax update', u, { :update => { :success => 'one', :failure => 'error' }, :remote => true } %>
<%#= link_to 'Ajax update', u, :update => 'one', :remote => true  %>
<%#= link_to 'Ajax update', u, :update => 'one', :remote => true  %>
<%#= button_to 'Ajax update', u, :update => 'one', :remote => true  %>
<%#= button_to 'Ajax update', u, :update => '#one', :remote => true, :method => 'get'  %>

<a href="#">a</a>

<%= yield %>

</body> </html>
